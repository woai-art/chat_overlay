<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Chat for vMix - Premium Edition</title>
    <style>
        /* ======================================== 
           –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --chat-height: 92vh;
            --message-padding: 12px;
            --avatar-size: 48px;
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: transparent;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #chat-container {
            position: absolute;
            top: 8vh;
            left: 2vw;
            width: 84vw;
            height: var(--chat-height);
            background: transparent;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 10px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: var(--message-padding) 16px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 100%;
            word-wrap: break-word;
            border-left: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: all var(--transition-speed) ease;
        }

        .message:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .avatar {
            width: var(--avatar-size);
            height: var(--avatar-size);
            border-radius: 50%;
            margin-right: 16px;
            flex-shrink: 0;
            border: 3px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            object-fit: cover;
            transition: all var(--transition-speed) ease;
        }

        .message:hover .avatar {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .username {
            font-weight: bold;
            color: #ffffff;
            font-size: 1.3em;
            margin-bottom: 6px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
            transition: all var(--transition-speed) ease;
        }

        .text {
            color: #f0f0f0;
            font-size: 1.1em;
            line-height: 1.5;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
        }

        /* ========================================
           –í–´–î–ï–õ–ï–ù–ò–ï –û–°–û–ë–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
           ======================================== */

        /* –°–ø–æ–Ω—Å–æ—Ä—ã */
        .message.sponsor {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.25);
            box-shadow: 0 0 25px rgba(76, 175, 80, 0.4);
        }

        .message.sponsor .username {
            color: #4CAF50;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
        }

        .message.sponsor .avatar {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        /* –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã */
        .message.moderator {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.25);
            box-shadow: 0 0 25px rgba(33, 150, 243, 0.4);
        }

        .message.moderator .username {
            color: #2196F3;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
        }

        .message.moderator .avatar {
            border-color: #2196F3;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.6);
        }

        /* –í–ª–∞–¥–µ–ª—å—Ü—ã –∫–∞–Ω–∞–ª–∞ */
        .message.owner {
            border-left-color: #FFD700;
            background: rgba(255, 215, 0, 0.25);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .message.owner .username {
            color: #FFD700;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
        }

        .message.owner .avatar {
            border-color: #FFD700;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
        }

        /* ========================================
           –ö–ù–û–ü–ö–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –¢–ï–ú–ê–ú–ò (–°–ö–†–´–¢–ê –î–õ–Ø VMIX)
           ======================================== */
        #theme-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }

        #theme-toggle:hover {
            opacity: 1;
        }

        #theme-toggle button {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #theme-toggle button:hover {
            background: rgba(0, 0, 0, 0.95);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        /* ========================================
           –¢–ï–ú–´
           ======================================== */
        
        /* –¢–ï–ú–ê: –ë–ê–†–ë–ò */
        .theme-barbie .message {
            background: rgba(255, 105, 180, 0.3);
            border-left-color: #ff69b4;
        }
        
        .theme-barbie .username {
            color: #ff69b4;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
        }

        /* –¢–ï–ú–ê: –ö–ò–ë–ï–†–ü–ê–ù–ö */
        .theme-cyberpunk .message {
            background: rgba(0, 255, 255, 0.15);
            border-left-color: #00ffff;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .theme-cyberpunk .username {
            color: #00ffff;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
            font-family: 'Courier New', monospace;
        }
        
        .theme-cyberpunk .text {
            color: #00ff88;
            font-family: 'Courier New', monospace;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
        }

        /* –¢–ï–ú–ê: –ú–ò–ù–ò–ú–ê–õ–ò–ó–ú */
        .theme-minimal .message {
            background: rgba(255, 255, 255, 0.9);
            border-left-color: #3498db;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .theme-minimal .username {
            color: #2c3e50;
            text-shadow: none;
        }
        
        .theme-minimal .text {
            color: #34495e;
            text-shadow: none;
        }

        /* –¢–ï–ú–ê: –¢–ï–ú–ù–ê–Ø –≠–õ–ï–ì–ê–ù–¢–ù–û–°–¢–¨ */
        .theme-dark-elegant .message {
            background: rgba(139, 92, 246, 0.2);
            border-left-color: #8b5cf6;
        }
        
        .theme-dark-elegant .username {
            color: #a78bfa;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
        }

        /* –¢–ï–ú–ê: –†–ï–¢–†–û –í–û–õ–ù–ê */
        .theme-retrowave {
            background-image: 
                linear-gradient(90deg, rgba(255, 0, 255, 0.05) 1px, transparent 1px),
                linear-gradient(rgba(255, 0, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .theme-retrowave .message {
            background: rgba(255, 0, 255, 0.2);
            border-left-color: #ff00ff;
            border: 1px solid rgba(255, 0, 255, 0.3);
        }
        
        .theme-retrowave .username {
            color: #ff00ff;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
            font-family: 'Arial Black', sans-serif;
        }
        
        .theme-retrowave .text {
            color: #00ffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
        }

        /* ========================================
           –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
           ======================================== */
        @media (max-width: 768px) {
            :root {
                --avatar-size: 36px;
                --message-padding: 10px;
            }
            
            .username {
                font-size: 1.1em;
            }
            
            .text {
                font-size: 1em;
            }
        }
    </style>
</head>
<body class="theme-barbie">
    <div id="chat-container"></div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –¥–ª—è vMix) -->
    <div id="theme-toggle">
        <button onclick="showThemeSelector()">üé®</button>
    </div>

    <script>
        // ========================================
        // –í–°–¢–†–û–ï–ù–ù–ê–Ø –ë–ê–ó–ê –≠–ú–û–î–ñ–ò
        // ========================================
        const EMOJI_MAP = {
            // –°–º–∞–π–ª–∏–∫–∏
            ':)': 'üòä', ':-)': 'üòä', ':(': 'üò¢', ':-(': 'üò¢',
            ':D': 'üòÑ', ':-D': 'üòÑ', ':P': 'üòõ', ':-P': 'üòõ',
            ';)': 'üòâ', ';-)': 'üòâ', ':o': 'üòÆ', ':-o': 'üòÆ',
            ':O': 'üò±', ':-O': 'üò±', ':|': 'üòê', ':-|': 'üòê',
            ':*': 'üòò', ':-*': 'üòò', '<3': '‚ù§Ô∏è', '</3': 'üíî',
            // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —ç–º–æ–¥–∂–∏
            ':heart:': '‚ù§Ô∏è', ':fire:': 'üî•', ':thumbsup:': 'üëç', ':thumbs_up:': 'üëç',
            ':thumbsdown:': 'üëé', ':thumbs_down:': 'üëé', ':clap:': 'üëè', ':clapping_hands:': 'üëè',
            ':wave:': 'üëã', ':waving_hand:': 'üëã', ':eyes:': 'üëÄ', ':hundred_points:': 'üíØ',
            ':rocket:': 'üöÄ', ':star:': '‚≠ê', ':crown:': 'üëë', ':gem:': 'üíé',
            ':thinking:': 'ü§î', ':thinking_face:': 'ü§î', ':joy:': 'üòÇ', ':face_with_tears_of_joy:': 'üòÇ',
            ':sob:': 'üò≠', ':loudly_crying_face:': 'üò≠', ':skull:': 'üíÄ', ':sunglasses:': 'üòé',
            ':smiling_face_with_sunglasses:': 'üòé', ':pray:': 'üôè', ':folded_hands:': 'üôè',
            ':muscle:': 'üí™', ':flexed_biceps:': 'üí™', ':ok_hand:': 'üëå', ':victory_hand:': '‚úåÔ∏è',
            // Twitch —ç–º–æ–¥–∂–∏ (fallback)
            ':pogchamp:': 'üò≤', ':kappa:': 'üòè', ':pepehands:': 'üò¢', ':monkas:': 'üò∞',
            ':omegalul:': 'üòÇ', ':lul:': 'üòÇ', ':ez:': 'üòé', ':copium:': 'ü§°', ':gigachad:': 'üí™',
            // –ñ–∏–≤–æ—Ç–Ω—ã–µ
            ':dog:': 'üê∂', ':cat:': 'üê±', ':bear:': 'üêª', ':panda_face:': 'üêº',
            // –î—Ä—É–≥–æ–µ
            ':glowing_star:': 'üåü', ':collision:': 'üí•', ':sweat_droplets:': 'üí¶'
        };

        function convertEmojis(text) {
            let result = text;
            for (const [code, emoji] of Object.entries(EMOJI_MAP)) {
                const escapedCode = code.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                result = result.replace(new RegExp(escapedCode, 'g'), emoji);
            }
            return result;
        }

        // ========================================
        // –°–ò–°–¢–ï–ú–ê –¢–ï–ú
        // ========================================
        const THEMES = {
            'barbie': 'üíó –ë–∞—Ä–±–∏',
            'cyberpunk': 'üåÜ –ö–∏–±–µ—Ä–ø–∞–Ω–∫',
            'minimal': '‚ö™ –ú–∏–Ω–∏–º–∞–ª–∏–∑–º',
            'dark-elegant': 'üñ§ –¢–µ–º–Ω–∞—è',
            'retrowave': 'üå∏ –†–µ—Ç—Ä–æ'
        };

        let currentTheme = localStorage.getItem('vmix-theme') || 'barbie';

        function applyTheme(theme) {
            Object.keys(THEMES).forEach(t => {
                document.body.classList.remove(`theme-${t}`);
            });
            document.body.classList.add(`theme-${theme}`);
            currentTheme = theme;
            localStorage.setItem('vmix-theme', theme);
            console.log(`üé® –¢–µ–º–∞: ${THEMES[theme]}`);
        }

        function nextTheme() {
            const themeKeys = Object.keys(THEMES);
            const currentIndex = themeKeys.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themeKeys.length;
            applyTheme(themeKeys[nextIndex]);
        }

        function showThemeSelector() {
            const existing = document.querySelector('.theme-popup');
            if (existing) {
                existing.remove();
                return;
            }

            const popup = document.createElement('div');
            popup.className = 'theme-popup';
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.95);
                border: 2px solid #444;
                border-radius: 15px;
                padding: 20px;
                z-index: 10000;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            `;

            let html = '<h3 style="color: white; margin-bottom: 15px; text-align: center;">üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</h3>';
            html += '<div style="display: grid; gap: 10px;">';
            
            Object.entries(THEMES).forEach(([key, name]) => {
                const active = key === currentTheme ? 'border: 3px solid #00ff88;' : '';
                html += `
                    <button onclick="applyTheme('${key}'); document.querySelector('.theme-popup').remove();"
                            style="background: #333; color: white; border: 2px solid #555; padding: 15px;
                                   border-radius: 10px; cursor: pointer; font-size: 16px; transition: all 0.3s;
                                   ${active}"
                            onmouseover="this.style.background='#555'"
                            onmouseout="this.style.background='#333'">
                        ${name}
                    </button>
                `;
            });

            html += '</div>';
            html += '<button onclick="this.parentElement.remove()" style="margin-top: 15px; width: 100%; background: #c00; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">–ó–∞–∫—Ä—ã—Ç—å</button>';
            
            popup.innerHTML = html;
            document.body.appendChild(popup);
        }

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                showThemeSelector();
            } else if (e.ctrlKey && e.key === 'ArrowRight') {
                e.preventDefault();
                nextTheme();
            }
        });

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
        applyTheme(currentTheme);

        // ========================================
        // –û–°–ù–û–í–ù–û–ô –ö–û–î –ß–ê–¢–ê
        // ========================================
        class vMixChat {
            constructor() {
                this.container = document.getElementById('chat-container');
                this.messages = new Map();
                this.messageLifetime = 900000; // 15 –º–∏–Ω—É—Ç
                this.maxMessages = 50;
                this.updateInterval = 1000;
                this.shownMessageIds = new Set();
                
                this.loadSettings();
                this.startUpdating();
                this.startCleanup();
                
                console.log('‚úÖ vMix Chat Premium –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }

            async loadSettings() {
                try {
                    const response = await fetch('chat_settings.json?' + Date.now());
                    if (response.ok) {
                        const settings = await response.json();
                        
                        // –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä—Å–µ—Ä–∞
                        this.messageLifetime = (settings.message_lifetime || 900) * 1000;
                        this.maxMessages = settings.max_messages || 50;
                        this.updateInterval = (settings.update_interval || 1) * 1000;
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ GUI
                        this.applyVisualSettings(settings);
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                        if (settings.theme && THEMES[settings.theme]) {
                            applyTheme(settings.theme);
                        }
                        
                        console.log('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', settings);
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                }
            }

            applyVisualSettings(settings) {
                const container = this.container;
                
                // –†–∞–∑–º–µ—Ä—ã –∏ –ø–æ–∑–∏—Ü–∏—è —á–∞—Ç–∞
                if (settings.chat_width) {
                    const width = settings.chat_width.includes('px') || settings.chat_width.includes('vw') || settings.chat_width.includes('%') 
                        ? settings.chat_width 
                        : settings.chat_width + 'px';
                    container.style.width = width;
                    console.log(`üìè –®–∏—Ä–∏–Ω–∞: ${width}`);
                }
                
                if (settings.chat_height) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –¥–ª—è –≤—ã—Å–æ—Ç—ã
                    const height = settings.chat_height.includes('px') || settings.chat_height.includes('vh') || settings.chat_height.includes('%') 
                        ? settings.chat_height 
                        : settings.chat_height + 'px';
                    container.style.height = height;
                    container.style.maxHeight = height; // –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
                    console.log(`üìè –í—ã—Å–æ—Ç–∞: ${height}`);
                }
                
                if (settings.chat_position_x) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ X
                    const posX = settings.chat_position_x.includes('px') || settings.chat_position_x.includes('vw') || settings.chat_position_x.includes('%') 
                        ? settings.chat_position_x 
                        : settings.chat_position_x + 'px';
                    container.style.left = posX;
                    console.log(`‚ÜîÔ∏è –ü–æ–∑–∏—Ü–∏—è X (—Å–ª–µ–≤–∞): ${posX}`);
                }
                
                if (settings.chat_position_y) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ Y
                    const posY = settings.chat_position_y.includes('px') || settings.chat_position_y.includes('vh') || settings.chat_position_y.includes('%') 
                        ? settings.chat_position_y 
                        : settings.chat_position_y + 'px';
                    container.style.top = posY;
                    console.log(`‚ÜïÔ∏è –ü–æ–∑–∏—Ü–∏—è Y (—Å–≤–µ—Ä—Ö—É): ${posY}`);
                }
                
                // –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
                if (settings.font_size) {
                    const fontSize = settings.font_size.includes('px') || settings.font_size.includes('em') || settings.font_size.includes('rem')
                        ? settings.font_size
                        : settings.font_size + 'px';
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –∏–º–µ–Ω–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ç–µ–∫—Å—Ç–∞–º —Å–æ–æ–±—â–µ–Ω–∏–π
                    const style = document.createElement('style');
                    style.id = 'custom-font-size';
                    style.textContent = `
                        .username { font-size: ${fontSize} !important; }
                        .text { font-size: calc(${fontSize} * 0.85) !important; }
                    `;
                    
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
                    const oldStyle = document.getElementById('custom-font-size');
                    if (oldStyle) oldStyle.remove();
                    
                    document.head.appendChild(style);
                }
                
                // –ê–≤–∞—Ç–∞—Ä—ã
                if (settings.show_avatars === false) {
                    const style = document.createElement('style');
                    style.id = 'hide-avatars';
                    style.textContent = '.avatar { display: none !important; }';
                    document.head.appendChild(style);
                } else {
                    const oldStyle = document.getElementById('hide-avatars');
                    if (oldStyle) oldStyle.remove();
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ addMessageToDOM
                this.settings = settings;
                
                console.log('‚ú® –í–∏–∑—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
            }

            async fetchMessages() {
                try {
                    const response = await fetch('messages.json?' + Date.now());
                    if (!response.ok) return;
                    
                    const messages = await response.json();
                    this.updateMessages(messages);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                }
            }

            updateMessages(newMessages) {
                const currentTime = Date.now();
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                const freshMessages = newMessages.filter(msg => {
                    const messageAge = currentTime - msg.timestamp;
                    return messageAge < this.messageLifetime && !this.shownMessageIds.has(msg.id);
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                freshMessages.forEach(msg => {
                    this.messages.set(msg.id, {
                        ...msg,
                        addedAt: currentTime
                    });
                    this.shownMessageIds.add(msg.id);
                    this.addMessageToDOM(msg);
                });

                // –û—á–∏—Å—Ç–∫–∞ Set –æ—Ç —Å—Ç–∞—Ä—ã—Ö ID
                if (this.shownMessageIds.size > 1000) {
                    const idsArray = Array.from(this.shownMessageIds);
                    this.shownMessageIds = new Set(idsArray.slice(-500));
                }

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                this.cleanupOldMessages();
            }

            addMessageToDOM(message) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                messageEl.dataset.id = message.id;
                messageEl.dataset.addedAt = Date.now();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å–ø–æ–Ω—Å–æ—Ä–æ–≤
                const highlightSponsors = this.settings?.highlight_sponsors !== false;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –æ—Å–æ–±—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
                if (highlightSponsors) {
                    if (message.author.is_owner) {
                        messageEl.classList.add('owner');
                    } else if (message.author.is_moderator) {
                        messageEl.classList.add('moderator');
                    } else if (message.author.is_sponsor) {
                        messageEl.classList.add('sponsor');
                    }
                }

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç–º–æ–¥–∂–∏
                const processedText = convertEmojis(message.text);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–≤
                const showAvatars = this.settings?.show_avatars !== false;
                const avatarHtml = showAvatars 
                    ? `<img class="avatar" src="${message.author.avatar}" 
                            onerror="if(!this.dataset.errorHandled){this.dataset.errorHandled='true';this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22%3E%3Crect width=%2248%22 height=%2248%22 fill=%22%23444%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2224%22%3Eüë§%3C/text%3E%3C/svg%3E';}" 
                            alt="${this.escapeHtml(message.author.name)}">`
                    : '';

                messageEl.innerHTML = `
                    ${avatarHtml}
                    <div class="message-content">
                        <div class="username">${this.escapeHtml(message.author.name)}</div>
                        <div class="text">${this.escapeHtml(processedText)}</div>
                    </div>
                `;

                this.container.appendChild(messageEl);

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ DOM
                const allMessages = this.container.querySelectorAll('.message');
                if (allMessages.length > this.maxMessages) {
                    allMessages[0].remove();
                }

                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                this.container.scrollTop = this.container.scrollHeight;
            }

            cleanupOldMessages() {
                const currentTime = Date.now();
                const elementsToRemove = [];

                this.messages.forEach((msg, id) => {
                    if (currentTime - msg.addedAt > this.messageLifetime) {
                        this.messages.delete(id);
                        const element = this.container.querySelector(`[data-id="${id}"]`);
                        if (element) {
                            elementsToRemove.push(element);
                        }
                    }
                });

                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                elementsToRemove.forEach(el => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(-30px)';
                    setTimeout(() => el.remove(), 300);
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            startUpdating() {
                this.fetchMessages();
                setInterval(() => this.fetchMessages(), this.updateInterval);
            }

            startCleanup() {
                // –û—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                setInterval(() => this.cleanupOldMessages(), 30000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            new vMixChat();
            console.log('üé¨ vMix Chat Premium –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
            console.log('‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: Ctrl+T (—Ç–µ–º—ã), Ctrl+‚Üí (—Å–ª–µ–¥—É—é—â–∞—è —Ç–µ–º–∞)');
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (e) => {
            console.error('‚ùå –û—à–∏–±–∫–∞ vMix Chat:', e.error);
        });
    </script>
</body>
</html>
